name: CI-CD Mini Project

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  WEB_AMI_ID: ami-0fa3fe0fa7920f68e
  DB_AMI_ID: ami-0fa3fe0fa7920f68e
  EC2_INSTANCE_TYPE: t3.micro
  EC2_KEY_NAME: key-pair
  ALERT_EMAIL: ychahbounia@gmail.com
  WEB_PUBLIC_IP: 52.71.4.237

############################
# 1️⃣ BUILD & TEST
############################
jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      # ---- Backend (Spring Boot) ----
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build backend
        working-directory: webapp/backend
        run: mvn clean package -DskipTests

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: webapp/backend/target/backend-0.0.1-SNAPSHOT.jar

      # ---- Frontend (Angular) ----
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend deps
        working-directory: webapp/frontend
        run: npm ci

      - name: Build frontend
        working-directory: webapp/frontend
        run: npm run build -- --configuration production

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: webapp/frontend/dist

  ############################
  # 2️⃣ DEPLOY INFRA
  ############################
  deploy-infra:
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy networking
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: mini-ci-cd-networking
          template: CloudFormation/networking.yaml
          no-fail-on-empty-changeset: "1"

      - name: Deploy security
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: mini-ci-cd-security
          template: CloudFormation/security.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides: >
            MyHomeIp=52.71.4.237/32

      - name: Deploy EC2
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: mini-ci-cd-ec2
          template: CloudFormation/ec2.yaml
          capabilities: CAPABILITY_IAM
          no-fail-on-empty-changeset: "1"
          parameter-overrides: >
            WebAmiId=${{ env.WEB_AMI_ID }},
            DbAmiId=${{ env.DB_AMI_ID }},
            InstanceType=${{ env.EC2_INSTANCE_TYPE }},
            KeyName=${{ env.EC2_KEY_NAME }},
            WebElasticIpAllocationId=eipalloc-07db1ed84c4491d56

  ############################
  # 3️⃣ DEPLOY APP
  ############################
  deploy-app:
    runs-on: ubuntu-latest
    needs: deploy-infra

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Download backend
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend

      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
      ##############
      - name: Debug frontend artifact
        run: |
          echo "Contenu du dossier frontend :"
          ls -R frontend 
      ###########################
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan ${{ env.WEB_PUBLIC_IP }} >> ~/.ssh/known_hosts

      # ---- Deploy Backend ----
      - name: Deploy backend
        run: |
          scp backend/backend-0.0.1-SNAPSHOT.jar ec2-user@${{ env.WEB_PUBLIC_IP }}:/home/ec2-user/app.jar
          ssh ec2-user@${{ env.WEB_PUBLIC_IP }} << 'EOF'
            sudo pkill -f app.jar || true
            nohup java -jar /home/ec2-user/app.jar --server.port=8080 > app.log 2>&1 &
          EOF

      # ---- Deploy Frontend ----
      - name: Deploy frontend
        run: |
          ssh ec2-user@${{ env.WEB_PUBLIC_IP }} "mkdir -p /tmp/frontend"
          scp -r frontend/dist/* ec2-user@${{ env.WEB_PUBLIC_IP }}:/tmp/frontend/
          ssh ec2-user@${{ env.WEB_PUBLIC_IP }} << 'EOF'
            sudo mkdir -p /usr/share/nginx/html
            sudo rm -rf /usr/share/nginx/html/* || true
            sudo cp -r /tmp/frontend/* /usr/share/nginx/html/
            sudo systemctl restart nginx || sudo systemctl start nginx
          EOF
