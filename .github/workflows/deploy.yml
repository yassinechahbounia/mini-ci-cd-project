name: CI-CD Mini Project

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  WEB_AMI_ID: ami-0fa3fe0fa7920f68e
  DB_AMI_ID: ami-0fa3fe0fa7920f68e
  EC2_INSTANCE_TYPE: t3.micro
  EC2_KEY_NAME: key-pair
  ALERT_EMAIL: ychahbounia@gmail.com
  WEB_INSTANCE_ID: i-0bdd3b6dd8e7b1c3c

jobs:
  build-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: app_db
          MYSQL_ROOT_PASSWORD: 123456
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -p123456"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      # ---------- Backend: Maven ----------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Backend - Maven build & tests
        working-directory: webapp/backend
        run: mvn -B clean package -DskipTests

      - name: Upload backend jar
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: webapp/backend/target/backend-0.0.1-SNAPSHOT.jar

      # ---------- Frontend: Angular ----------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Frontend - Install dependencies
        working-directory: webapp/frontend
        run: npm ci

      - name: Frontend - Build Angular
        working-directory: webapp/frontend
        run: npm run build -- --configuration production

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: webapp/frontend/dist
##################################################
  deploy-infra:
    runs-on: ubuntu-latest
    needs: build-test
    environment: production

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------- Deploy networking ----------
      - name: Deploy networking stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        continue-on-error: true
        with:
          name: mini-ci-cd-networking
          template: CloudFormation/networking.yaml
          no-fail-on-empty-changeset: "1"

      # ---------- Deploy security ----------
      - name: Deploy security stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        continue-on-error: true
        with:
          name: mini-ci-cd-security
          template: CloudFormation/security.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides: >-
            MyHomeIp=52.71.4.237/32

      # ---------- Deploy EC2 ----------
      - name: Deploy ec2 stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: mini-ci-cd-ec2
          template: CloudFormation/ec2.yaml
          no-fail-on-empty-changeset: "1"
          capabilities: CAPABILITY_IAM
          parameter-overrides: >-
            WebAmiId=${{ env.WEB_AMI_ID }},
            DbAmiId=${{ env.DB_AMI_ID }},
            InstanceType=${{ env.EC2_INSTANCE_TYPE }},
            KeyName=${{ env.EC2_KEY_NAME }},
            WebElasticIpAllocationId=eipalloc-07db1ed84c4491d56

      # ---------- Deploy monitoring ----------
      - name: Deploy monitoring stack
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: mini-ci-cd-monitoring
          template: CloudFormation/monitoring.yaml
          no-fail-on-empty-changeset: "1"
          parameter-overrides: >-
            AlertEmail=${{ env.ALERT_EMAIL }},
            WebEc2InstanceId=${{ env.WEB_INSTANCE_ID }}
##################################################
  deploy-app:
    runs-on: ubuntu-latest
    needs: deploy-infra
    environment: production

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Restore backend build
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: backend-artifact

      - name: Restore frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-artifact

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan 52.71.4.237 >> ~/.ssh/known_hosts

      - name: Copy backend jar to EC2
        run: |
          scp backend-artifact/backend-0.0.1-SNAPSHOT.jar ec2-user@52.71.4.237:/home/ec2-user/app.jar

      - name: Copy frontend dist to EC2
        run: |
          ssh ec2-user@52.71.4.237 "mkdir -p /home/ec2-user/frontend"
          scp -r frontend-artifact/. ec2-user@52.71.4.237:/home/ec2-user/frontend/

      - name: Restart backend service
        run: |
          ssh ec2-user@52.71.4.237 "
            # Tue l'ancien processus s'il existe
            sudo pkill -f 'app.jar' || true
            
            # Lancement avec redirection totale et désaffiliation du shell
            # Le 'disown' est important pour détacher le job du shell actuel
            nohup java -jar /home/ec2-user/app.jar --server.port=8080 > /home/ec2-user/app.log 2>&1 & 
            sleep 2
          "
#